@{
    ViewData["Title"] = "Add Book";
    Layout = "~/Views/Shared/_LayoutDashboard.cshtml";
}

<div class="content container-fluid pb-0">

    <div class="page-header">
        <div class="content-page-header ">
            <h5>Book</h5>
            <div class="list-btn">
                <ul class="filter-list">
                    <li>
                        <a class="btn btn-filters w-auto popup-toggle" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-original-title="Filter"><span class="me-2"><img src="~/assets/img/icons/filter-icon.svg" alt="filter"></span>Filter </a>
                    </li>
                    <li class="">
                        <div class="dropdown dropdown-action" data-bs-toggle="tooltip" data-bs-placement="top" title="download">
                            <a href="#" class="btn-filters" data-bs-toggle="dropdown" aria-expanded="false"><span><i class="fe fe-download"></i></span></a>
                            <div class="dropdown-menu dropdown-menu-end">
                                <ul class="d-block">
                                    <li>
                                        <a class="d-flex align-items-center download-item" href="javascript:void(0);" download><i class="far fa-file-pdf me-2"></i>PDF</a>
                                    </li>
                                    <li>
                                        <a class="d-flex align-items-center download-item" href="javascript:void(0);" download><i class="far fa-file-text me-2"></i>CVS</a>
                                    </li>
                                </ul>
                            </div>
                        </div>                                                         
                    </li>
                    <li>
                        <a class="btn-filters" href="javascript:void(0);" data-bs-toggle="tooltip" data-bs-placement="bottom" title="print"><span><i class="fe fe-printer"></i></span> </a>
                    </li>
                    <li>
                        <a class="btn btn-import" href="javascript:void(0);"><span><i class="fe fe-check-square me-2"></i>Import</span></a>
                    </li>
                    <li>
                        <a class="btn btn-primary" href="javascript:void(0);" data-bs-toggle="modal" data-bs-target="#add_book"><i class="fa fa-plus-circle me-2" aria-hidden="true"></i>Add Book</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <!-- /Page Header -->

    <!-- Search Filter -->
    <div id="filter_inputs" class="card filter-card">
        <div class="card-body pb-0">
            <div class="row">
                <div class="col-sm-6 col-md-3">
                    <div class="input-block mb-3">
                        <label>Book Name</label>
                        <input type="text" class="form-control">
                    </div>
                </div>
                <div class="col-sm-6 col-md-3">
                    <div class="input-block mb-3">
                        <label>Reference Number</label>
                        <input type="text" class="form-control">
                    </div>
                </div>
                <div class="col-sm-6 col-md-3">
                    <div class="input-block mb-3">
                        <label>Amount</label>
                        <input type="text" class="form-control">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- /Search Filter -->

    <div class="row">
        <div class="col-sm-12">
            <div class=" card-table">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover datatable">
                            <thead class="thead-light">
                                <tr>
                                    <th>#</th>
                                    <th style="display: none;">book_id</th> 
                                    <th>Book Name</th>
                                    <th>Reference Number</th>
                                    <th>Amount</th>
                                    <th>Description</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Book Modal -->
    <div class="modal custom-modal modal-lg fade" id="add_book" role="dialog">
        <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <div class="form-header modal-header-title text-start mb-0">
                        <h4 class="mb-0">Add Book</h4>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="#">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12">
                                <div class="input-block mb-2">
                                    <label>Book Name</label>
                                    <input type="text" class="form-control" placeholder="Enter Name" id="bookName">
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12 col-sm-12">
                                <div class="input-block mb-2">
                                    <label>Reference Number</label>
                                    <input type="text" class="form-control" placeholder="Reference Number" id="bookReferenceNumber">
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12 col-sm-12">
                                <div class="input-block mb-2">
                                    <label>Amount</label>
                                    <input type="number" class="form-control" placeholder="Enter Amount" id="bookAmount">
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12 col-sm-12">
                                <div class="input-block mb-2">
                                    <label>Description</label>
                                    <textarea class="form-control" placeholder="Enter Description" id="bookDescription"></textarea>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12 col-sm-12">
                                <div class="input-block mb-2">
                                    <label>Date</label>
                                    <input type="datetime-local" class="form-control" name="book_date" id="bookDate">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" data-bs-dismiss="modal" class="btn btn-back cancel-btn me-2">Cancel</button>
                        <button type="submit" data-bs-dismiss="modal" class="btn btn-primary" id="addBook">Add Book</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Book Modal -->
    <div class="modal custom-modal modal-lg fade" id="Edit_book" role="dialog">
        <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <div class="form-header modal-header-title text-start mb-0">
                        <h4 class="mb-0">Edit Book</h4>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="#">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12">
                                <div class="input-block mb-2">
                                    <label>Book Name</label>
                                    <input type="text" class="form-control" placeholder="Enter Name" id="bookNameUP">
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12 col-sm-12">
                                <div class="input-block mb-2">
                                    <label>Reference Number</label>
                                    <input type="text" class="form-control" placeholder="Reference Number" id="bookReferenceNumberUP">
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12 col-sm-12">
                                <div class="input-block mb-2">
                                    <label>Amount</label>
                                    <input type="number" class="form-control" placeholder="Enter Amount" id="bookAmountUP">
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12 col-sm-12">
                                <div class="input-block mb-2">
                                    <label>Description</label>
                                    <textarea class="form-control" placeholder="Enter Description" id="bookDescriptionUP"></textarea>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12 col-sm-12">
                                <div class="input-block mb-2">
                                    <label>Date</label>
                                    <input type="datetime-local" class="form-control" name="book_date" placeholder="Enter Date" id="bookDateUP">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" data-bs-dismiss="modal" class="btn btn-back cancel-btn me-2">Cancel</button>
                        <button type="submit" data-bs-dismiss="modal" class="btn btn-primary" id="editBook">Update</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // Fetch books and populate table
            fetchBooks();

            // Event handler for adding a book
            $('#addBook').on('click', function (e) {
                e.preventDefault();

                let data = {
                    book_name: $('#bookName').val(),
                    book_reference_number: $('#bookReferenceNumber').val(),
                    book_description: $('#bookDescription').val(),
                    book_date: $('#bookDate').val(),
                    book_amount: $('#bookAmount').val()
                };

                $.ajax({
                    url: '/api/AddBook/AddBook',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function () {
                        $('#add_book').modal('hide');
                        alert('Book added successfully!');
                        fetchBooks(); // Refresh list
                    },
                    error: function (xhr) {
                        alert('Failed to add book: ' + xhr.responseText);
                    }
                });
            });

            // Event handler to open edit modal with current book data
            $('.datatable').on('click', '.btn-edit', function () {
                let bookId = $(this).data('id');
                $.get('/api/AddBook/GetBook/' + bookId, function (data) {
                    $('#bookNameUP').val(data.book_name);
                    $('#bookReferenceNumberUP').val(data.book_reference_number);
                    $('#bookAmountUP').val(data.book_amount);
                    $('#bookDescriptionUP').val(data.book_description);
                    $('#bookDateUP').val(data.book_date);
                    $('#Edit_book').data('id', bookId).modal('show');
                });
            });

            // Submit updated book data
            $('#editBook').on('click',  function (e) {
                e.preventDefault();
                let bookId = $('#Edit_book').data('id'); 

                if (!bookId) return; 

                let updatedData = {
                    book_id: bookId,
                    book_name: $('#bookNameUP').val(),
                    book_reference_number: $('#bookReferenceNumberUP').val(),
                    book_description: $('#bookDescriptionUP').val(),
                    book_date: $('#bookDateUP').val(),
                    book_amount: $('#bookAmountUP').val()
                };

                $.ajax({
                    url: '/api/AddBook/UpdateBook/' + bookId,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(updatedData),
                    success: function () {
                        alert('Book updated successfully!');
                        $('#Edit_book').modal('hide');
                        fetchBooks(); // Refresh the book list
                    },
                    error: function () {
                        alert('Failed to update book');
                    }
                });
            });

            // Fetch and display books in the table
            function fetchBooks() {
                $.get('/api/AddBook/GetBooks', function (data) {
                    let tableBody = $('.datatable tbody');
                    tableBody.empty();
                    $.each(data, function (index, book) {
                        tableBody.append(
                            `<tr>
                                <td>${index + 1}</td>
                                <td><span>${book.book_name}</span></td>
                                <td>${book.book_reference_number}</td>
                                <td>${book.book_amount}</td>
                                <td>${book.book_description}</td>
                                <td>${book.book_date}</td>
                                <td class="d-flex align-items-center">
                                    <a class="btn-action-icon me-2 btn-edit" data-id="${book.book_id}" href="javascript:void(0);">
                                        <i class="fe fe-edit"></i>
                                    </a>
                                    <a class="btn-action-icon btn-delete" data-id="${book}" href="javascript:void(0);">
                                    <i class="fe fe-trash-2"></i>
                                    </a>
                                </td>
                            </tr>`
                        );
                    });
                });
            }
        });
    </script>
