@{
	ViewData["Title"] = "Add Expense";
	Layout = "~/Views/Shared/_LayoutDashboard.cshtml";
}

<div class="content container-fluid pb-0">
	<!-- Page Header -->
	<div class="page-header">
		<div class="content-page-header">
			<h5>Expenses</h5>
			<div class="list-btn">
				<ul class="filter-list">
					<li>
						<a class="btn btn-filters w-auto popup-toggle" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-original-title="Filter"><span class="me-2"><img src="~/assets/img/icons/filter-icon.svg" alt="filter"></span>Filter </a>
					</li>
					<li>
						<a class="btn-filters" href="javascript:void(0);" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Settings"><span><i class="fe fe-settings"></i></span> </a>
					</li>
					<li>
						<a class="btn btn-primary" href="javascript:void(0);" data-bs-toggle="modal" data-bs-target="#add_expenses"><i class="fa fa-plus-circle me-2" aria-hidden="true"></i>Add Expenses</a>
					</li>
				</ul>
			</div>
		</div>
	</div>
	<!-- /Page Header -->
	<!-- Table -->
	<div class="row">
	<div class="col-sm-12">
		<div class="card-table">
			<div class="card-body">
				<div class="table-responsive">
					<table class="table table-striped table-hover datatable">
						<thead class="thead-light">
							<tr>
								<th>#</th>
								<th style="display: none;">expense_id</th> <!-- Hidden column -->
								<th>Category Name</th>
								<th>Expense Name</th>
								<th>Category Ref Number</th>
								<th>Expense Description</th>
								<th>Expense Date</th>
								<th class="text-end">Action</th>
							</tr>
						</thead>
						<tbody>
							
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>
</div>

	<!-- /Table -->





<!-- Add Expenses Modal -->
<div class="modal custom-modal modal-lg fade" id="add_expenses" role="dialog">
	<div class="modal-dialog modal-dialog-centered modal-md">
		<div class="modal-content">
			<div class="modal-header border-0 pb-0">
				<div class="form-header modal-header-title text-start mb-0">
					<h4 class="mb-0">Add Expenses</h4>
				</div>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<form action="#">
				<div class="modal-body">
					<div class="row">
						<div class="col-md-12">
							<div class="card-body">
								<div class="border-0 pb-0">
									<div class="row">
										<div class="col-lg-4 col-md-6 col-sm-12">
	                                     <div class="input-block mb-3">
											<label>Expense Category</label>
											<select class="form-control" name="expense_category_id" id="expense_category_id">
								         	<option value="">Select Category</option>
											@foreach (var category in ViewBag.Categories)
																												{
											<option value="@category.Id">@category.Name</option>
											}
										</select>
									</div>
								</div>
										<div class="col-lg-4 col-md-6 col-sm-12">
											<div class="input-block mb-3">
												<label>Reference Number</label>
												<input type="text" class="form-control" placeholder="Enter Reference No" name="expense_reference_number" id="expense_ref_number">
											</div>
										</div>
										<div class="col-lg-4 col-md-6 col-sm-12">
											<div class="input-block mb-3">
												<label>Expense Name</label>
												<input type="text" class="form-control" placeholder="Enter Expense Name" name="expense_name" id="expense_name">
											</div>
										</div>
										<div class="col-lg-4 col-md-6 col-sm-12">
											<div class="input-block mb-4">
												<label>Expense Date</label>
												<input type="datetime-local" class="form-control" name="expense_date" id=expense_date>
											</div>
										</div>
										<div class="col-lg-4 col-md-6 col-sm-12">
											<div class="input-block mb-6" id="summernote_container">
												<label class="form-control-label">Description</label>
												<textarea class="summernote form-control" placeholder="Enter Description" name="expense_description" id="expense_description"></textarea>
											</div>
										</div>
										
										<div class="col-lg-12 col-md-12">
											<div class="input-block">
												<label>Attachment</label>
												<div class="input-block service-upload mb-0">
													<span><img src="~/assets/img/icons/drop-icon.svg" alt="upload"></span>
													<h6 class="drop-browse align-center">Drop your files here or<span class="text-primary ms-1">browse</span></h6>
													<p class="text-muted">Maximum size: 50MB</p>
													<input type="file" multiple="" name="attachments">
													<div id="frames"></div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" data-bs-dismiss="modal" class="btn btn-back cancel-btn me-2">Cancel</button>
					<button type="submit" class="btn btn-primary paid-continue-btn" id="addexpense">Add Expenses</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- /Add Expenses Modal -->
<!-- Edit Expenses Modal -->
<div class="modal custom-modal modal-lg fade" id="edit_expenses" role="dialog">
	<div class="modal-dialog modal-dialog-centered modal-md">
		<div class="modal-content">
			<div class="modal-header border-0 pb-0">
				<div class="form-header modal-header-title text-start mb-0">
					<h4 class="mb-0">Edit Expenses</h4>
				</div>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
				</button>
			</div>
			<form action="#">
				<div class="modal-body">
					<div class="row">
						<div class="col-md-12">
							<div class="card-body">
								<div class="border-0 pb-0">
									<div class="row">
										<div class="col-lg-4 col-md-6 col-sm-12">
											<div class="input-block mb-3">
												<label>Expense ID</label>
												<input type="text" class="form-control" placeholder="Enter Expense ID">
											</div>
										</div>
										<div class="col-lg-4 col-md-6 col-sm-12">
											<div class="input-block mb-3">
												<label>Reference</label>
												<input type="text" class="form-control" placeholder="Enter Reference No">
											</div>
										</div>
										<div class="col-lg-4 col-md-6 col-sm-12">
											<div class="input-block mb-3">
												<label>Amount </label>
												<input type="number" class="form-control" placeholder="Enter Amount">
											</div>
										</div>
										<div class="col-lg-4 col-md-6 col-sm-12">
											<div class="input-block mb-3">
												<label>Payment Mode</label>
												<select class="select">
													<option>Select Payment Mode</option>
													<option>Cash</option>
													<option>Cheque</option>
												</select>
											</div>
										</div>
										<div class="col-lg-4 col-md-6 col-sm-12">
											<div class="input-block mb-3">
												<label>Expense Date </label>
												<input type="text" class="form-control datetimepicker" placeholder="Select Expense Date">
											</div>
										</div>
										<div class="col-lg-4 col-md-6 col-sm-12">
											<div class="input-block mb-3">
												<label>Payment Status</label>
												<select class="select">
													<option>Select Payment Status</option>
													<option>Paid</option>
													<option>Pending</option>
													<option>Cancelled</option>
												</select>
											</div>
										</div>
										<div class="col-lg-12 col-md-12 description-box">
											<div class="input-block mb-3" id="summernote_container2">
												<label class="form-control-label">Description</label>
												<textarea class="summernote form-control" placeholder="Type your message"></textarea>
											</div>
										</div>
										<div class="col-lg-12 col-md-12">
											<div class="input-block">
												<label>Attachment</label>
												<div class="input-block service-upload mb-0">
													<span><img src="/assets/img/icons/drop-icon.svg"alt="upload"></span>
													<h6 class="drop-browse align-center">Drop your files here or<span class="text-primary ms-1">browse</span></h6>
													<p class="text-muted">Maximum size: 50MB</p>
													<input type="file" multiple="" id="image_sign2">
													<div id="frames2"></div>
												</div>
											</div>
										</div>
									</div>
								</div>

							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" data-bs-dismiss="modal" class="btn btn-back cancel-btn me-2">Cancel</button>
					<button type="submit" data-bs-dismiss="modal" class="btn btn-primary paid-continue-btn">Update</button>
				</div>
			</form>
		</div>
	</div>
</div>
<!-- /Edit Expenses Modal -->
<!-- Delete Items Modal -->
<div class="modal custom-modal fade" id="delete_modal" role="dialog">
	<div class="modal-dialog modal-dialog-centered modal-md">
		<div class="modal-content">
			<div class="modal-body">
				<div class="form-header">
					<h3>Delete Expenses</h3>
					<p>Are you sure want to delete?</p>
				</div>
				<div class="modal-btn delete-action">
					<div class="row">
						<div class="col-6">
							<button type="reset" data-bs-dismiss="modal" class="w-100 btn btn-primary paid-continue-btn">Delete</button>
						</div>
						<div class="col-6">
							<button type="submit" data-bs-dismiss="modal" class="w-100 btn btn-primary paid-cancel-btn">Cancel</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- /Delete Items Modal -->

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
	$(document).ready(function () {
     fetchExpenses();

	$('#addexpense').on('click', function (e) {
		e.preventDefault(); 

		
		let selectedCategoryId = $('#expense_category_id').val();
		console.log(selectedCategoryId);

		// Collect form data
		let data = {
			expense_category_id: selectedCategoryId,
			expense_reference_number: $('#expense_ref_number').val(),
			expense_name: $('#expense_name').val(),
			expense_date: $('#expense_date').val(),
			expense_description: $('#expense_description').val(),
			// Uncomment below if you want to handle file attachments
			// attachments: $('input[name="attachments"]').prop('files')
		};

		console.log(data); 

		// If you have file attachments, uncomment the lines below
		/*
		let attachments = $('input[name="attachments"]').prop('files');
		for (let i = 0; i < attachments.length; i++) {
			formData.append('attachments', attachments[i]);
		}
		*/

		// AJAX call to add expense
		$.ajax({
			url: '/api/Expense/Addexpense',
			type: 'POST',
			contentType: 'application/json', 
			data: JSON.stringify(data), 
			success: function (response) {
				alert('Expense added successfully!'); 
				$('#add_expenses').modal('hide'); 
				$('form')[0].reset(); 
			},
			error: function (xhr) {
				alert('Failed to add expense: ' + xhr.responseText); 
			}
		});
	});

});



 function fetchExpenses() {
		$.ajax({
			url: '/api/Expense/GetExpenses', // Adjust the URL to your endpoint for fetching expenses
			type: 'GET',
			success: function (response) {
				let tbody = $('.datatable tbody'); // Select the tbody of your table
				tbody.empty(); // Clear the current table body

				// Populate the table with the fetched data
				response.forEach((expense, index) => {
					tbody.append(`
						<tr>
							<td>${index + 1}</td>
							<td style="display: none;">${expense.expense_id}</td> <!-- Hidden column for expense ID -->
							<td>${expense.expense_category_name}</td>
							<td>${expense.expense_name}</td>
							<td>${expense.expense_reference_number}</td>
							<td>${expense.expense_description}</td>
							<td>${new Date(expense.expense_date).toLocaleDateString()}</td>
							<td class="text-end">
								<button class="btn btn-warning btn-sm" onclick="editExpense(${expense.expense_id})">Edit</button>
								<button class="btn btn-danger btn-sm" onclick="deleteExpense(${expense.expense_id})">Delete</button>
							</td>
						</tr>
					`);
				});
			},
			error: function (xhr) {
				alert('Failed to fetch expenses: ' + xhr.responseText);
			}
		});
		
};
</script>

