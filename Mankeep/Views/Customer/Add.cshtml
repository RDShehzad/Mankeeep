@{
	ViewData["Title"] = "Add Customer";
	Layout = "~/Views/Shared/_LayoutDashboard.cshtml";
}

<div class="content container-fluid pb-0">
	
	<div class="page-header">
		<div class="content-page-header ">
			<h5>Customer</h5>
			<div class="list-btn">
				<ul class="filter-list">
					<li>
						<a class="btn btn-filters w-auto popup-toggle" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-original-title="Filter"><span class="me-2"><img src="~/assets/img/icons/filter-icon.svg" alt="filter"></span>Filter </a>
					</li>
					<li class="">
						<div class="dropdown dropdown-action" data-bs-toggle="tooltip" data-bs-placement="top" title="download">
							<a href="#" class="btn-filters" data-bs-toggle="dropdown" aria-expanded="false"><span><i class="fe fe-download"></i></span></a>
							<div class="dropdown-menu dropdown-menu-end">
								<ul class="d-block">
									<li>
										<a class="d-flex align-items-center download-item" href="javascript:void(0);" download><i class="far fa-file-pdf me-2"></i>PDF</a>
									</li>
									<li>
										<a class="d-flex align-items-center download-item" href="javascript:void(0);" download><i class="far fa-file-text me-2"></i>CVS</a>
									</li>
								</ul>
							</div>
						</div>														
					</li>
					<li>
						<a class="btn-filters" href="javascript:void(0);" data-bs-toggle="tooltip" data-bs-placement="bottom" title="print"><span><i class="fe fe-printer"></i></span> </a>
					</li>
					<li>
						<a class="btn btn-import" href="javascript:void(0);"><span><i class="fe fe-check-square me-2"></i>Import</span></a>
					</li>
					<li>
						<a class="btn btn-primary" href="javascript:void(0);" data-bs-toggle="modal" data-bs-target="#add_customer"><i class="fa fa-plus-circle me-2" aria-hidden="true"></i>Add Customer</a>
					</li>
				</ul>
			</div>
		</div>
	</div>
	<!-- /Page Header
	<!-- /Page Header -->

	<!-- Search Filter -->
	<div id="filter_inputs" class="card filter-card">
		<div class="card-body pb-0">
			<div class="row">
				<div class="col-sm-6 col-md-3">
					<div class="input-block mb-3">
						<label>Name</label>
						<input type="text" class="form-control">
					</div>
				</div>
				<div class="col-sm-6 col-md-3">
					<div class="input-block mb-3">
						<label>Email</label>
						<input type="text" class="form-control">
					</div>
				</div>
				<div class="col-sm-6 col-md-3">
					<div class="input-block mb-3">
						<label>Phone</label>
						<input type="text" class="form-control">
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- /Search Filter -->

	<div class="row">
		<div class="col-sm-12">
			<div class=" card-table">
				<div class="card-body">
					<div class="table-responsive">
						<table class="table table-striped table-hover datatable">
							<thead class="thead-light">
								<tr>
									<th>#</th>
									<th style="display: none;">customer_id</th> 
									<th>Customer Name</th>
									<th>Reference Number</th>
									<th>Phone</th>
									<th>Address</th>
									<th>Description</th>
									<th>Date</th>
									<th>Balance</th>
									<th>Actions</th>
								</tr>
							</thead>
							<tbody>

							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal custom-modal modal-lg fade" id="add_customer" role="dialog">
		<div class="modal-dialog modal-dialog-centered modal-md">
			<div class="modal-content">
				<div class="modal-header border-0 pb-0">
					<div class="form-header modal-header-title text-start mb-0">
						<h4 class="mb-0">Add Customer</h4>
					</div>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<form action="#">
					<div class="modal-body">
						<div class="row">
							<div class="col-lg-6 col-md-6 col-sm-12">
								<div class="input-block mb-2">
									<label>Customer Name</label>
									<input type="text" class="form-control" placeholder="Enter Name" id="customerName">
								</div>
							</div>
							<div class="col-lg-6 col-md-12 col-sm-12">
								<div class="input-block mb-2">
									<label>Reference Number</label>
									<input type="text" class="form-control" placeholder="Reference Number" id="customerReferenceNumber">
								</div>
							</div>
							<div class="col-lg-6 col-md-12 col-sm-12">
								<div class="input-block mb-2">
									<label>Customer Phone</label>
									<input type="number" class="form-control" placeholder="Enter Phone Number" id="customerPhone">
								</div>
							</div>
							<div class="col-lg-6 col-md-12 col-sm-12">
								<div class="input-block mb-2">
									<label>Address</label>
									<input type="text" class="form-control" placeholder="Enter Address" id="customerAddress">
								</div>
							</div>
							<div class="col-lg-6 col-md-12 col-sm-12">
								<div class="input-block mb-2">
									<label>Date</label>
									<input type="datetime-local" class="form-control" name="customer_date" id="customerDate">
								</div>
							</div>
							<div class="col-lg-6 col-md-12 col-sm-12">
								<div class="input-block mb-2">
									<label>Balance</label>
									<input type="number" class="form-control" placeholder="Enter Balance" id="customerBalance">
								</div>
							</div>
							<div class="col-lg-8 col-md-6 col-sm-12">
								<div class="input-block mb-2">
									<label>Description</label>
									<textarea class="form-control" placeholder="Enter Description" id="customerDescription"></textarea>
								</div>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" data-bs-dismiss="modal" class="btn btn-back cancel-btn me-2">Cancel</button>
						<button type="submit" data-bs-dismiss="modal" class="btn btn-primary" id="addCustomer">Add Customer</button>
					</div>
				</form>
			</div>
		</div>
	</div>



	<div class="modal custom-modal modal-lg fade" id="Edit_customer" role="dialog">
	<div class="modal-dialog modal-dialog-centered modal-md">
		<div class="modal-content">
			<div class="modal-header border-0 pb-0">
				<div class="form-header modal-header-title text-start mb-0">
					<h4 class="mb-0">Edit Customer</h4>
				</div>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<form action="#">
				<div class="modal-body">
					<div class="row">
						<div class="col-lg-6 col-md-6 col-sm-12">
							<div class="input-block mb-2">
								<label>Customer Name</label>
								<input type="text" class="form-control" placeholder="Enter Name" id="customernameUP">
							</div>
						</div>
						<div class="col-lg-6 col-md-12 col-sm-12">
							<div class="input-block mb-2">
								<label>Reference Number</label>
								<input type="text" class="form-control" placeholder="Reference Number" id="customerrefnumberUP">
							</div>
						</div>
						<div class="col-lg-6 col-md-12 col-sm-12">
							<div class="input-block mb-2">
								<label>Customer Phone</label>
								<input type="number" class="form-control" placeholder="Enter Phone Number" id="customerphoneUP">
							</div>
						</div>
						<div class="col-lg-6 col-md-12 col-sm-12">
							<div class="input-block mb-2">
								<label>Address</label>
								<input type="text" class="form-control" placeholder="Enter Address" id="customeraddressUP">
							</div>
						</div>
						<div class="col-lg-6 col-md-12 col-sm-12">
							<div class="input-block mb-2">
								<label>Date</label>
								<input type="datetime-local" class="form-control" name="customer_date" placeholder="Enter Date" id="customerdateUP">
							</div>
						</div>
						<div class="col-lg-6 col-md-12 col-sm-12">
							<div class="input-block mb-2">
								<label>Closing Balance</label>
								<input type="number" class="form-control" placeholder="Enter Closing Balance Amount" id="customerbalanceUP">
							</div>
						</div>
						<div class="col-lg-8 col-md-6 col-sm-12">
							<div class="input-block mb-2" id="summernote_container">
								<label class="form-control-label">Description</label>
								<textarea class="summernote form-control" placeholder="Enter Description" name="customer_description" id="customerdescriptionUP"></textarea>
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" data-bs-dismiss="modal" class="btn btn-back cancel-btn me-2">Cancel</button>
					<button type="submit" data-bs-dismiss="modal" class="btn btn-primary paid-continue-btn" id="editcustomer">Update</button>
				</div>
			</form>
		</div>
	</div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
	$(document).ready(function () {
		// Fetch customer and populate table
		fetchCustomer();

		// Event handler for adding a customer
		$('#addCustomer').on('click', function (e) {
			e.preventDefault();

			let data = {
				customer_name: $('#customerName').val(),
				customer_reference_number: $('#customerReferenceNumber').val(),
				customer_phone: $('#customerPhone').val(),
				customer_address: $('#customerAddress').val(),
				customer_description: $('#customerDescription').val(),
				customer_date: $('#customerDate').val(),
				Balance: $('#customerBalance').val()
			};

			$.ajax({
				url: '/api/Customer/AddCustomer',
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify(data),
				success: function () {
					$('#add_customer').modal('hide');
					alert('Customer added successfully!');
					fetchCustomer(); // Refresh list
				},
				error: function (xhr) {
					alert('Failed to add supplier: ' + xhr.responseText);
				}
			});
		});


		// Event handler to open edit modal with current customer data
		$('.datatable').on('click', '.btn-edit', function () {
			let customerId = $(this).data('id');
			$.get('/api/Customer/getCustomer/' + customerId, function (data) {
				$('#customernameUP').val(data.customer_name);
				$('#customerrefnumberUP').val(data.customer_reference_number);
				$('#customerphoneUP').val(data.customer_phone);
				$('#customeraddressUP').val(data.customer_address);
				$('#customerdescriptionUP').val(data.customer_description);
				$('#customerdateUP').val(data.customer_date);
				$('#customerbalanceUP').val(data.balance);
				$('#Edit_customer').data('id', customerId).modal('show');
			});
		});

		// Submit updated customer data
		$('#editcustomer').on('click',  function (e) {
			e.preventDefault();
			let customerId = $('#Edit_customer').data('id'); 

			if (!customerId) return; 

			let updatedData = {
				customer_id: customerId,
				customer_name: $('#customernameUP').val(),
				customer_reference_number: $('#customerrefnumberUP').val(),
				customer_phone: $('#customerphoneUP').val(),
				customer_address: $('#customeraddressUP').val(),
				customer_description: $('#customerdescriptionUP').val(),
				customer_date: $('#customerdateUP').val(),
				Balance: $('#customerbalanceUP').val()
			};

			$.ajax({
				url: '/api/Customer/updateCustomer/' + customerId,
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify(updatedData),
				success: function () {
					alert('Customer updated successfully!');
					$('#Edit_customer').modal('hide');
					fetchCustomer(); // Refresh the supplier list
				},
				error: function () {
					alert('Failed to update Customer');
				}
			});
		});










		// Fetch and display customer in the table
		function fetchCustomer() {
			$.get('/api/Customer/getCustomer', function (data) {
				let tableBody = $('.datatable tbody');
				tableBody.empty();
				console.log(data);
				$.each(data, function (index, customer) {
					tableBody.append(`
						<tr>
							<td>${index + 1}</td>
							<td><span>${customer.customer_name}</span></td>
							<td>${customer.customer_reference_number}</td>
							<td>${customer.customer_phone}</td>
							<td>${customer.customer_address}</td>
							<td>${customer.customer_description}</td>
							<td>${customer.customer_date}</td>
							<td>${customer.balance}</td>
							<td class="d-flex align-items-center">
								<a class="btn-action-icon me-2 btn-edit" data-id="${customer.customer_id}" href="javascript:void(0);">
									<i class="fe fe-edit"></i>
								</a>
								<a class="btn-action-icon btn-delete" data-id="${customer}" href="javascript:void(0);">
								<i class="fe fe-trash-2"></i>
								</a>
							</td>
						</tr>
					`);
				});
			});
		}
	});
</script>
